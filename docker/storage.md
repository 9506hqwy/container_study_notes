# ストレージ

コンテナの永続化ストレージは `Volume` が推奨される。

```text
Volumes are the preferred mechanism for persisting data generated by and used by Docker containers.
While bind mounts are dependent on the directory structure and OS of the host machine, volumes are completely managed by Docker
```

## `Volume`

既定でボリュームは作成されない。

```sh
docker volume ls
```

```text
```

ボリュームを作成してコンテナを起動する。

```sh
docker run --name test --rm -d --mount type=volume,dst=/vol redhat/ubi10 tail -f /dev/null
```

```text
f9a2fa814f540c3093fad8a6d53f634bc802a158092b7cd7836a4d4e730a7f5e
```

ボリュームを確認する。

```sh
docker volume ls
```

```text
DRIVER    VOLUME NAME
local     2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0
```

ボリュームの詳細を確認する。

```sh
docker volume inspect 2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0
```

```json
[
    {
        "CreatedAt": "2025-12-12T20:23:23+09:00",
        "Driver": "local",
        "Labels": {
            "com.docker.volume.anonymous": ""
        },
        "Mountpoint": "/var/lib/docker/volumes/2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0/_data",
        "Name": "2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0",
        "Options": null,
        "Scope": "local"
    }
]
```

コンテナのマウントポイントを確認する。

```sh
docker exec test df -Th /vol
```

```text
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda4      xfs    38G  3.0G   35G   8% /vol
```

コンテナホストのマウントポイントを同じになる。

```sh
sudo df -Th /var/lib/docker/volumes
```

```text
ファイルシス   タイプ サイズ  使用  残り 使用% マウント位置
/dev/sda4      xfs       38G  3.0G   35G    8% /
```

コンテナの設定を確認する。

```sh
docker inspect test --format "{{json .Mounts}}" | jq
```

```json
[
  {
    "Type": "volume",
    "Name": "2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0",
    "Source": "/var/lib/docker/volumes/2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0/_data",
    "Destination": "/vol",
    "Driver": "local",
    "Mode": "z",
    "RW": true,
    "Propagation": ""
  }
]
```

ファイルを書き込む。

```sh
docker exec test touch /vol/a.txt
```

ファイルを確認する。

```sh
sudo ls -l /var/lib/docker/volumes/2b732269e5afa3904efe62257e840ac34941c18aebad6fc24151afd8ad0f89f0/_data
```

```text
合計 0
-rw-r--r--. 1 root root 0 12月 12 20:48 a.txt
```

ボリュームのファイルをコピーする。
別のコンテナにボリュームをマウントしてファイルをコピーする。

```sh
docker run --rm --volumes-from test -v $(pwd):/backup redhat/ubi10 cp /vol/a.txt /backup
```

ファイルを確認する。

```sh
ls -l a.txt
```

```text
-rw-r--r--. 1 root root 0 12月 12 20:52 a.txt
```

コンテナを停止すると名前付きではないボリュームは削除される。

```sh
docker stop test
```

```text
test
```

ボリュームも削除される。

```sh
docker volume ls
```

```text
DRIVER    VOLUME NAME
```

## `Bind`

コンテナホストのファイルシステムをマウントする。
コンテナとコンテナホストで共有可能になる。

ディレクトリを作成してコンテナを起動する。

```sh
mkdir vol
docker run --name test --rm -d --mount type=bind,src=$(pwd)/vol,dst=/vol redhat/ubi10 tail -f /dev/null
```

```text
6eb80596c777e39627e4b6cb619e2759fd63164acb154bd4437c6e9738221e95
```

コンテナのマウントポイントを確認する。

```sh
docker exec test df -Th /vol
```

```text
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/sda5      xfs    19G  392M   18G   3% /vol
```

コンテナホストのマウントポイントを同じになる。

```sh
df -Th .
```

```text
ファイルシス   タイプ サイズ  使用  残り 使用% マウント位置
/dev/sda5      xfs       19G  392M   18G    3% /home
```

コンテナの設定を確認する。

```sh
docker inspect test --format "{{json .Mounts}}" | jq
```

```json
[
  {
    "Type": "bind",
    "Source": "/home/centos10/vol",
    "Destination": "/vol",
    "Mode": "",
    "RW": true,
    "Propagation": "rprivate"
  }
]
```

ファイルを書き込む。

```sh
docker exec test touch /vol/a.txt
```

ファイルを確認する。

```sh
ls -l vol
```

```text
合計 0
-rw-r--r--. 1 root root 0 12月 12 21:26 a.txt
```

## `tempfs`

コンテナホストのメモリをマウントする。

コンテナを起動する。

```sh
docker run --name test --rm -d --mount type=tmpfs,dst=/vol redhat/ubi10 tail -f /dev/null
```

```text
1cc552bf7cc333912b967d6dc58a4c1c77772600ca67a6f2538a6abd47f220f7
```

コンテナのマウントポイントを確認する。

```sh
docker exec test df -Th /vol
```

```text
Filesystem     Type   Size  Used Avail Use% Mounted on
tmpfs          tmpfs  334M     0  334M   0% /vol
```

コンテナの設定を確認する。

```sh
docker inspect test --format "{{json .Mounts}}" | jq
```

```json
[
  {
    "Type": "tmpfs",
    "Source": "",
    "Destination": "/vol",
    "Mode": "",
    "RW": true,
    "Propagation": ""
  }
]
```

ファイルを書き込む。

```sh
docker exec test touch /vol/a.txt
```

## 参考

- [Storage](https://docs.docker.com/engine/storage/)
